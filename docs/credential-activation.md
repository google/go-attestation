# Credential Activation

Credential activation remotely proves a specific attestation key resides on
the same TPM as a specific endorsement key. Because the endorsement key is the
cryptographic identifier for a TPM (and by extension, the device), credential
activation enables a remote system to establish trust in a new key, which can
then be used to encrypt or attest on behalf of the device.

Credential Activation is a poorly documented TPM concept. This document
aims to explain how it works and what it is used for, without assuming any
knowledge of the TCG specifications.

## Overview

Abstractly: credential activation allows a remote party to verify one key is
on the same TPM as another key, and that the key has a specific set of
properties.

The description in the first paragraph describes the activation of an
attestation key with the endorsement key. While this is the most common use
of credential activation, any two asymmetric key-pairs in the TPM can be
used.

### How it works

The credential activation procedure involves the remote end generating a
specially-crafted, encrypted challenge for the TPM to process. The server
generates this challenge based on knowledge of two TPM keys (specifically,
their public keys and key properties), and the secret data it wishes to
encrypt.

This challenge can be decrypted by the TPM using the `ActivateCredential`
command. Through this command, the user presents to the TPM:

 * The encrypted challenge generated by the server
 * A handle to the 1st key
 * A handle to the 2nd key

If the keys and their properties are present on the TPM, and match exactly
the keys the server used to generate the challenge, the TPM will decrypt
the secret contained within, and return it as the response to the command.

## Why use credential activation?

**TL;DR: Credential activation lets you trust a new key.**

While devices are typically identified by the endorsement key burned into
their TPM, key usage restrictions set on most endorsement keys mean they
typically cannot be used for signing or attestation. As such a different
key is needed.

After the new key is generated on the TPM, the credential activation
procedure allows you to prove that:

 * The new key has acceptable properties (ie: A key intended for attestation
   can only be used in attestation commands, and the key material cannot be
   exported).
 * The new key is present & on the same TPM as an endorsement key.

Once credential activation completes successfully, the remote end can be
sure of the properties of the key & which device it was generated for, and
start trusting the use of the new key on behalf of the device.

## Detailed process

### Glossary

**Activation key** - The first public key. Credential activation verifies that
this key is resident on the TPM, *and it has a specific set of properties.*

**Anchor key** - The second public key. Credential activation verifies this
key is resident on the same TPM as the activation key.

### Sequence of operations

![sequence diagram](credential_activation.png)

1. The Client device informs the server of the public keys of both the anchor
   and activation key, as well as communicating the key properties of the
   activation key.

2. The server computes the activation challenge, as described below. This
   challenge is sent back to the client.

3. The Client invokes the `ActivateCredential` command, providing the encrypted
   challenge from the server, and handles to the two keys.

4. If the keys handles presented have public keys / properties matching those
   the server used when computing the challenge, the TPM will be able to
   decrypt and return the secret.

## Appendix: Generating the credential activation challenge

### Inputs to the generator

1. The digest of the activation key. Using the terminology of the
   [specification](https://www.trustedcomputinggroup.org/wp-content/uploads/TPM-Rev-2.0-Part-2-Structures-01.38.pdf),
   this is called the `TPM2B_NAME`. The structure this digest is computed over
   includes the public key, the key usage constraints of the key, and
   parameters for using the key in asymmetric and symmetric ciphers.

2. The public side of the anchor key.

3. The secret value to encrypt (should be known to the server but not to
   the client).

4. A cryptographically-secure random number source.

### Process

This process is formally documented in section 24 of the
[TPM specification](https://trustedcomputinggroup.org/resource/tpm-library-specification/),
revision 2 part 1.

1. The server reads 16 bytes from the source of randomness. This is called the
   seed, and will be used as an input when generating a key to encrypt the
   secret with.

2. The seed is asymmetrically encrypted using the public side of the anchor
   key. For RSA anchor keys, this is done using OAEP encryption with the
   label `IDENTITY`.

3. The encryption key for the secret is generated by combining the seed, the
   digest of the activation key, and the fixed string `STORAGE` in a key
   derivation function called *KDFa*. This derivation function is documented
   in section 11.4.9.2 of the same specification.

4. The generated encryption key is used to encrypt the secret. This is done
   using AES in CFB mode, with null bytes for the initialization vector.

5. A HMAC is generated to protect the integrity of the encrypted secret. The
   key for the HMAC is generated in the same way as the key in step 3, except
   the fixed string `INTEGRITY` is used instead of `STORAGE`. The HMAC is
   computed over the encrypted secret & the digest of the activation key
   (which should be concatenated together in that order for the HMAC).

6. Finally, the different components of the challenge are combined into a
   single structure:

   1. The HMAC & encrypted secret are both prefixed with their length, before
      being combined into a single structure which itself is then
      length-prefixed.

   2. The encrypted seed (generated in step 2) is then prefixed with its
      length, before being concatenated with the structure above.

   Overall, the entire construction looks like this:

   ![packet diagram](credential_activation_pkt.png)
